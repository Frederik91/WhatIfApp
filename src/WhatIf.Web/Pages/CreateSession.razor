@page "/CreateSession"
@using Microsoft.AspNetCore.Http.Extensions
@using WhatIf.Core.Services
@using WhatIf.Web.Models

@inject IPlayerService PlayerService
@inject ISessionService SessionService
@inject NavigationManager NavigationManager
@inject ProtectedSessionStorage ProtectedSessionStore


<h1>Create session</h1>

<p><MatTextField @bind-Value="@name" Label="Nickname"></MatTextField></p>
<p><MatTextField @bind-Value="@sessionName" Label="Game name"></MatTextField></p>

<MatButton OnClick="@Create">Create</MatButton>

@code {
    private string sessionName = "";
    private string name = string.Empty;

    private async Task Create()
    {
        var session = await SessionService.Create(sessionName);
        if (session is null)
            return;

        var player = await PlayerService.Create(name, session.Id);
        await SessionService.SetGameMaster(session.Id, player.Id);

        var playerSessionState = new SessionPlayerState { SessionId = session.Id, PlayerId = player.Id, IsGameMaster = true };
        await ProtectedSessionStore.SetAsync("state", playerSessionState);

        NavigationManager.NavigateTo($"sessionlobby");
    }
}
