@page "/CreateSession"
@using Microsoft.AspNetCore.Http.Extensions
@using WhatIf.Core.Services
@using WhatIf.Web.Models

@inject IPlayerService PlayerService
@inject IMatToaster Toaster
@inject ISessionService SessionService
@inject NavigationManager NavigationManager
@inject ProtectedSessionStorage ProtectedSessionStore


<h1>Create session</h1>

@if (_isCreating)
{
    <h3 class="mat-subtitle1">Creating game: @name</h3>
    <MatProgressBar Progress="@Progress"></MatProgressBar>
}
else
{
    <p><MatTextField @bind-Value="@name" Label="Nickname"></MatTextField></p>
    <MatButton OnClick="@Create">Create</MatButton>
}



@code {
    private string name = string.Empty;
    private double _progress;
    private bool _isCreating;

    public bool IsCreating
    {
        get => _isCreating;
        set { _isCreating = value; StateHasChanged(); }
    }

    public double Progress
    {
        get => _progress;
        set { _progress = value; StateHasChanged(); }
    }

    private async Task Create()
    {
        Progress = 0;
        IsCreating = true;
        try
        {
            var session = await SessionService.Create();
            Progress = 0.2;
            if (session is null)
                return;

            var player = await PlayerService.Create(name, session.Id, true);
            Progress = 0.5;

            var playerSessionState = new SessionPlayerState {SessionId = session.Id, PlayerId = player.Id, IsGameMaster = true};
            await ProtectedSessionStore.SetAsync("state", playerSessionState);
            Progress = 1;

            NavigationManager.NavigateTo("sessionlobby");
        }
        catch (Exception e)
        {
            Toaster.Add(e.Message, MatToastType.Danger, "Error");
        }
        finally
        {
            IsCreating = false;
        }


    }
}
